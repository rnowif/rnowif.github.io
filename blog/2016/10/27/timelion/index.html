<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Timelion, le petit nouveau de Kibana 5 - Renaud Humbert-Labeaumaz</title>
  <meta name="author" content="Renaud Humbert-Labeaumaz">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://rnowif.github.io/blog/2016/10/27/timelion/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Renaud Humbert-Labeaumaz" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://rnowif.github.io/blog/2016/10/27/timelion/">
  <meta property="og:title" content="Timelion, le petit nouveau de Kibana 5 - Renaud Humbert-Labeaumaz">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      
        <header role="banner">
          <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Renaud Humbert-Labeaumaz</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li ><a href="/blog/archives">Archives</a></li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="rnowif.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


        </header>
      
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Renaud Humbert-Labeaumaz" />
    
    <meta itemprop="url" content="https://rnowif.github.io" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-10-27T09:26:16+13:00"  data-updated="true" itemprop="datePublished dateCreated">Thu 27 Oct 2016,  9:26 AM</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Timelion, le petit nouveau de Kibana 5
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p>Elastic vient de sortir <a href="https://www.elastic.co/blog/elastic-stack-5-0-0-released">sa dernière mouture de la stack Elastic</a>. Il s'agit de la version 5 et, pour la première fois, tous les produits ont une version commune. Cette nouvelle version vient avec son lot de nouveautés. Dans cet article, nous allons nous concentrer sur les nouveautés apportées à Kibana, et principalement Timelion.</p>

<p>Les exemples sont tirés de métriques fournies par le plugin <a href="https://www.elastic.co/guide/en/beats/metricbeat/5.0/metricbeat-getting-started.html">MetricBeat</a>, qui remplace TopBeat dans la version 5 de la stack.</p>

<!-- more -->


<h2>Généralités</h2>

<p>Au lancement de Kibana, on remarque tout d'abord le changement visuel. Le menu est désormais à gauche, les icônes un peu cryptiques de Kibana 4 pour ajouter, sauvegarder ou ouvrir des éléments sont remplacées par des boutons avec du texte et les contours des visualisations dans les dashboards sont supprimés. Pour le reste, on retrouve assez vite ses habitudes de Kibana 4.</p>

<p><img class="center" src="/images/kibana_new_look.png"></p>

<p>Les principales évolutions tiennent dans l'ajout des plugins <a href="https://www.elastic.co/guide/en/sense/current/introduction.html">Sense</a> et <a href="https://www.elastic.co/fr/blog/timelion-timeline">Timelion</a> (prononcez <em>timeline</em>). Ces modules ne sont pas nouveaux mais ils sont désormais intégrés de base dans Kibana.</p>

<h2>Timelion</h2>

<h3>Présentation</h3>

<p>Timelion permet d'afficher des courbes décrites par un langage particulier. Pour accéder à cette fonctionnalité, il faut cliquer sur l'icône avec une tête de lion.</p>

<p><img class="center" src="/images/timelion_intro.png"></p>

<p>La requête décrivant la courbe à afficher est présente dans le champ au dessus de la courbe. La requête de base est <code>.es(*)</code>. Cela va afficher le nombre total d'événements reçus au fil du temps. La datasource <code>.es</code> (ou <code>.elasticsearch</code>) permet d'effectuer une <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html">requête lucène</a> dans l'index elasticsearch par défaut. Il est possible de spécifier l'index et la requête de cette manière :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(index='metricbeat-*', q='*')</span></code></pre></td></tr></table></div></figure>


<p><em>NB : Il existe plusieurs datasources en plus de Elasticsearch, notamment Graphite, <a href="https://www.quandl.com/">Quandl</a> et <a href="http://data.worldbank.org/">WorldBank</a></em></p>

<h3>Afficher une courbe</h3>

<p>Si on veut afficher une métrique plutôt que le nombre d'événements, il est possible d'ajouter un attribut <code>metric</code> à la requête. Les métriques disponibles sont <code>avg</code>, <code>sum</code>, <code>min</code>, <code>max</code> et <code>cardinality</code> (nombre de valeurs distinctes). Par exemple, pour afficher l'évolution de la consommation CPU de java, il faut effectuer la requête suivante :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(q='metricset.name:process AND system.process.name:java', metric='sum:system.process.cpu.total.pct')</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/evolution_cpu_java.png"></p>

<p>Timelion affiche la requête en label de la courbe, ce qui n'est pas très lisible ici. Il est donc possible de fournir sont propre label avec la fonction <code>label()</code> :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(q='metricset.name:process AND system.process.name:java', metric='sum:system.process.cpu.total.pct').label('Consommation CPU Java')</span></code></pre></td></tr></table></div></figure>


<h3>Afficher plusieurs courbes</h3>

<p>Maintenant, on aimerait afficher également le nombre d'événements qui arrivent afin de chercher une éventuelle corrélation entre la consommation CPU et la charge d'événements. Pour ce faire, il suffit d'ajouter à la requête une deuxième datasource, afin de récupérer ce nombre d'événements. Cependant, les deux échelles n'ont rien à voir, il faut donc ajouter une deuxième axe y avec la fonction <code>yaxis</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(q='metricset.name:process AND system.process.name:java', metric='sum:system.process.cpu.total.pct').label('Consommation CPU Java'), .es(*).yaxis(yaxis=2).label('Evénements')</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/java_cpu_vs_events.png"></p>

<p>Les variations de la courbe des événements n'est pas très visible, on va donc fixer un seuil minimal à l'axe y pour y voir plus clair, avec la propriété <code>min</code> de <code>yaxis</code>. Avec un titre en plus (fonction <code>title</code>) et des couleurs fixes (fonction <code>color</code>), le graphe est prêt à mettre dans un dashboard.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(q='metricset.name:process AND system.process.name:java', metric='sum:system.process.cpu.total.pct').label('Consommation CPU Java').color('#F00'), .es(*).yaxis(yaxis=2, min=330).label('Evénements').color('#00F').title('Consommation CPU vs Evénements')</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/cpu_vs_events_final.png"></p>

<p>Visiblement, la charge n'est pas suffisante pour voir une corrélation entre la consommation CPU et le nombre d'événements.</p>

<h3>Opérer sur des courbes</h3>

<p>Timelion propose également de faire des opérations entre les courbes. Par exemple, il est possible de suivre la taille moyenne des paquets qui arrivent par l'interface <em>lo</em> en divisant (avec la fonction <code>divide</code>) le volume moyen qui transite par le nombre moyen de paquets.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(q='metricset.name:network AND system.network.name:lo', metric='avg:system.network.in.bytes').divide(.es(q='metricset.name:network AND system.network.name:lo', metric='avg:system.network.in.packets')).label('Taille moyenne des paquets')</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/avg_packet_size.png"></p>

<p><em>NB : Il existe de nombreuses opérations qu'il est possible d'utiliser pour traiter les courbes : <code>abs</code>, <code>movingaverage</code>, <code>multiply</code>, <code>subtract</code>, <code>sum</code>, etc. Se référer à la <a href="https://github.com/elastic/timelion/blob/master/FUNCTIONS.md">documentation complète</a> pour plus d'informations</em></p>

<h2>Conclusion</h2>

<p>Kibana 5 est assez agréable à utiliser mais ne change pas radicalement l'expérience utilisateur par rapport à la version 4. Les retouches graphiques sont appréciables mais les évolutions réellement impactantes sont à chercher du coté des plugins Sense et Timelion. Ce dernier est un outil très puissant pour mettre des courbes de différentes sources en corrélation (ou d'index différents dans un même cluster Elasticsearch) et je suis sûr que vous trouverez des tas de cas d'usage bien plus pertinents que ceux que j'ai pu montrer dans cet article.</p>
</div>


      <footer class="post-footer">
        <p class="meta text-muted">
          
  



<figure class="author-image">
    <span class="img" href="/about" style="background-image: url(/images/renaud.png)"><span class="hidden">Picture</span></span>
</figure>

<section class="author">
    <h4><span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="fn" itemprop="name">Renaud Humbert-Labeaumaz</span></span></h4>

    <a class="fa fa-link" href="https://rnowif.github.io">
        <span class="hidden">https://rnowif.github.io</span>
    </a>
    <a class="fa fa-twitter" href="https://twitter.com/rnowif">
        <span class="hidden">rnowif</span>
    </a>
    <a class="fa fa-github" href="https://github.com/rnowif">
        <span class="hidden">rnowif</span>
    </a>
</section>

<hr>

<section class="share">
    
    <h4>Share this post</h4>
    
    <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?url=https://rnowif.github.io/blog/2016/10/27/timelion/;"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="fa fa-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://rnowif.github.io/blog/2016/10/27/timelion/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="fa fa-google-plus" href="https://plus.google.com/share?url=https://rnowif.github.io/blog/2016/10/27/timelion/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
    
</section>




<!--
<footer class="post-footer">


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Instant%20Movie%20Streamer%20v3%20Release&amp;url=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://iyask.me/instant-movie-streamer-v3-release/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>


        </footer>


-->

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-10-27T09:26:16+13:00"  data-updated="true" itemprop="datePublished dateCreated">Thu 27 Oct 2016,  9:26 AM</time>
          <br>

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/elastic/'>elastic</a>, <a class='category' href='/blog/categories/elk/'>elk</a>, <a class='category' href='/blog/categories/kibana/'>kibana</a>
  
</span>


        </p>
        
          <div class="pager">
            
            
              
                <a href="/blog/2016/07/31/quoi-de-neuf-dans-spring-5/" class="col-xs-12 col-md-4 btn btn-default" title="Previous Post: Quoi de neuf dans Spring 5"> 
                  <div class="text-muted">
                    <small>Previous Post</small>
                  </div>
                  <div class="pager-title">
                    <h4>Quoi de neuf dans Spring 5</h4>
                  </div>
                </a>
              
            
            
            
              
              <a href="/blog/2016/11/03/ecrire-des-tests-plus-robustes-au-changement/" class="col-xs-12 col-md-4 btn btn-default pull-right" title="Next Post: Ecrire des tests plus robustes au changement">
                <div class="text-muted">
                  <small>Next Post</small>
                </div>
                <div class="pager-title">
                  <h4>Ecrire des tests plus robustes au changement</h4>
                </div>
              </a>
              
            
            
          </div>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - Renaud Humbert-Labeaumaz<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/bhrigu123/abacus">abacus theme</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'rnowif';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://rnowif.github.io/blog/2016/10/27/timelion/';
        var disqus_url = 'https://rnowif.github.io/blog/2016/10/27/timelion/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
